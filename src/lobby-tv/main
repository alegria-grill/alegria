#!/usr/bin/env ruby

require './src/alegria'
require 'date'
require './src/File_Loop'

puts ` echo on 0 | cec-client -s -d 1 ; `.strip
sleep 3

minimize_windows
hide_mouse_cursor
auto_git_pull
auto_hide_cursor

HOME_DIR = '/home/pi'.freeze
puts "=== Current directory: #{HOME_DIR}"
puts "=== Date: #{Time.now}"

do_loop = true

def run_cmd(cmd)
  puts "=== Running: #{cmd}"
  puts `#{cmd}`.strip
end

def update_bg(s_file)
  run_cmd %(pcmanfm --wallpaper-mode=fit --set-wallpaper "#{s_file}")
end

def show_time
  run_cmd %(/apps/alegria/src/time.sign.rb update)
  time_sign = '/tmp/time.sign.svg'
  if File.exist?(time_sign)
    update_bg(time_sign)
    return true
  end

  false
end

# photos = File_Loop.new(
#   %[find "#{HOME_DIR}/Pictures/\" -maxdepth 1 -type f -iname '*.jpg' -or -iname '*.png' | sort -R --random-source=/dev/urandom]
# )
photo_ext  = %( -type f -iname '*.jpg' -or -iname '*.png' -or -iname '*.heic' )
# office     = File_Loop.new(%[find "/apps/slides/lobby-tv" -maxdepth 1 #{photo_ext} ])
# slide_show = File_Loop.new(%[find "#{HOME_DIR}/Pictures/" -maxdepth 1 #{photo_ext}   ])
# fun_videos = File_Loop.new(%[find "#{HOME_DIR}/Videos/fun" -maxdepth 1 -type f -iname '*.webm' -or -iname '*.mp4'])
# corp_videos = File_Loop.new(%[find "#{HOME_DIR}/Videos/" -maxdepth 1 -type f -iname 'Laser*' -or -name 'DEL*'])
videos     = File_Loop.new(%(find "#{HOME_DIR}/Videos/" -maxdepth 1 -type f -iname '*.webm' -or -iname '*.mp4'))
seasonal = File_Loop.new(%(find "/apps/slides/exports" -maxdepth 1 #{photo_ext} ))

class Accidents
  @@last_time = 0
  class << self
    def update
      new_time = File.read('/apps/alegria/data/last.accident.timestamp')
      if new_time != @@last_time
        @@last_time = new_time
        system 'sh/run update accident sign'
        return true
      end
      false
    end

    def show
      update
      run_cmd %(pcmanfm --wallpaper-mode=fit --set-wallpaper "/tmp/accident.svg")
    end
  end # class << self
end # def

def hour
  Time.now.strftime('%k').to_i
end

def early_morning?
  hour < 7
end

def shutdown?
  hour > (12 + 4)
end

Accidents.show

while do_loop

  sleep 1
  if early_morning?
    system %(amixer set Master 85%)
  else
    system %(amixer set Master 20%)
  end
  sleep 1

  # if early_morning?
  #   # run_cmd(%[pcmanfm --wallpaper-mode=fit --set-wallpaper "#{slide_show.next}"])
  #   system %(mpv --sub-auto=fuzzy --fullscreen "#{fun_videos.next}")
  #   next
  # end

  if shutdown?
    puts ` echo standby 0 | cec-client -s -d 1 ; `.strip
    do_loop = false
    system '/apps/alegria/sh/run pull'
    Accidents.show
    next
  end

  next_photo = seasonal.next
  if next_photo
    run_cmd %(pcmanfm --wallpaper-mode=fit --set-wallpaper "#{next_photo}")
    sleep 30
    case next_photo
    when /party/
      sleep 1200
      show_time
      sleep 15
    when /safety_week/
      Accidents.show
      sleep 10

      begin
        show_time
        sleep 15
      rescue Exception => e
        e
      end
    end
  else
    system %(mpv --sub-auto=fuzzy --fullscreen "#{videos.next}")
  end
  # system %(mpv --sub-auto=fuzzy --fullscreen "#{videos.next}")
  # sleep 20

end # while

# #!/usr/bin/env ruby
#
# require "./src/alegria"
#
# minimize_windows
# hide_mouse_cursor
#
# auto_reboot
# auto_git_pull
# auto_hide_cursor
#
# while true
#   Alegria.pcmanfm_wallpaper("images/lobby-tv/current.png")
#   sleep_to_min
#   while !on_15th_minute?
#     sleep_to_min
#   end
# end # while
