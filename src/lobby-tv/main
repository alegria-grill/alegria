#!/usr/bin/env ruby

require "./src/alegria"
minimize_windows
hide_mouse_cursor


HOME_DIR="/home/pi"
puts "=== Current directory: #{HOME_DIR}"
puts "=== Date: #{Time.now}"

do_loop = true

# fbi -a -t 5 -noverbose -u -l $PWD/list.txt || {

class File_Loop
  attr_reader :i, :list
  def initialize(cmd)
    @i = 0
    @list = `#{cmd}`.strip.split("\n"))
  end # def

  def next
    photo = @list[@i]
    @i += 1
    @i = 0 if @i > (@list.size - 1)
    photo
  end

  def current
    @list[@i]
  end

  def nth?(x)
    (@i % x) == 0
  end
end # class

photos = File_Loop.new(`find "#{HOME_DIR}/Pictures/" -maxdepth 1 -type f -iname '*.jpg' -or -iname '*.png' | sort -R --random-source=/dev/urandom`
videos = File_Loop.new(`find "#{HOME_DIR}/Videos/ -maxdepth 1 -type f -iname '*.webm' -or -iname '*.mp4'`)

while do_loop
  puts `feg --bg-fill "#{photos.next}"`.strip
  sleep 5
  if photos.nth?(10)
    `vlc -f --no-video-title-show #{videos.next}`
  end
  if Time.now.strftime('%k').to_i > (12 + 4)
    puts ` echo standby 0 | cec-client -s -d 1 ; `.strip
    do_loop = false
  end
end # while
